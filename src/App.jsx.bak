import React, { useState, useEffect } from 'react';
import WelcomeScreen from './components/WelcomeScreen';
import ExamScreen from './components/ExamScreen';
import ResultScreen from './components/ResultScreen';
import questionsData from './data/questions.json';
import { shuffleArray, getFlaggedIds } from './utils';

function App() {
  const [view, setView] = useState('welcome');
  const [examState, setExamState] = useState(null);

  const startExam = (mode, setType) => {
    let selectedQuestions = [];
    const allQuestions = [...questionsData];

    if (setType === 'random') {
      selectedQuestions = shuffleArray(allQuestions).slice(0, 24);
    } else {
      const flaggedIds = getFlaggedIds();
      // Find the question objects for flagged IDs
      const flaggedQuestions = allQuestions.filter(q => flaggedIds.includes(q.question_id));
      
      if (flaggedQuestions.length >= 24) {
        selectedQuestions = shuffleArray(flaggedQuestions).slice(0, 24);
      } else {
        // Need to fill
        const needed = 24 - flaggedQuestions.length;
        const otherQuestions = allQuestions.filter(q => !flaggedIds.includes(q.question_id));
        const filled = shuffleArray(otherQuestions).slice(0, needed);
        selectedQuestions = [...flaggedQuestions, ...filled];
      }
    }

    // Ensure we have questions (if empty data/flags)
    if (selectedQuestions.length === 0) {
        // Fallback if no questions at all (shouldn't happen with 11 json files)
       selectedQuestions = allQuestions.slice(0, 24);
    }

    setExamState({
      mode,
      questions: selectedQuestions,
      initialFlags: getFlaggedIds(),
      startTime: Date.now()
    });
    setView('exam');
  };

  const handleSubmit = (data) => {
    setExamState(prev => ({ ...prev, ...data }));
    setView('result');
  };

  const handleRestart = () => {
    setExamState(null);
    setView('welcome');
  };

  return (
    <div className="App">
      {view === 'welcome' && (
        <WelcomeScreen 
          onStart={startExam} 
          totalQuestions={questionsData.length} 
        />
      )}
      {view === 'exam' && examState && (
        <ExamScreen
          mode={examState.mode}
          questions={examState.questions}
          initialFlags={examState.initialFlags}
          initialAnswers={{}}
          onSubmit={handleSubmit}
        />
      )}
      {view === 'result' && examState && (
        <ResultScreen
          questions={examState.questions}
          answers={examState.answers || {}}
          flaggedIds={examState.flags || []}
          onRestart={handleRestart}
          allQuestions={questionsData}
        />
      )}
    </div>
  );
}

export default App;
